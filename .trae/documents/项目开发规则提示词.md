# ThinkAdmin 项目开发规则

## 1. 后端控制器开发规范

### 控制器必须参考标准

```php
<?php
namespace app\admin\controller;

use think\admin\Controller;

/**
 * 功能模块管理
 */
class ModuleName extends Controller
{
    /**
     * 列表页面
     * @auth true
     * @menu true
     */
    public function index()
    {
        return $this->fetch();
    }
    
    /**
     * 表单页面
     * @auth true
     */
    public function form()
    {
        return $this->fetch();
    }
    
    /**
     * 删除数据
     * @auth true
     */
    public function remove()
    {
        // 删除逻辑
    }
}
```

### 必须遵守的规则

1. **继承基类**：必须继承 `think\admin\Controller`
2. **权限注解**：每个方法必须添加 `@auth true`
3. **菜单注解**：主要页面添加 `@menu true`
4. **命名规范**：使用 PascalCase 命名控制器类
5. **方法规范**：index(列表)、form(表单)、remove(删除)

## 2. 模型文件开发规范

### 模型必须参考标准

```php
<?php
namespace app\admin\model;

use think\admin\Model;

/**
 * 数据模型
 */
class ModelName extends Model
{
    /**
     * 数据表名
     */
    protected $name = 'table_name';
    
    /**
     * 自动时间戳
     */
    protected $autoWriteTimestamp = true;
    
    /**
     * 字段类型转换
     */
    protected $type = [
        'status' => 'integer',
        'create_time' => 'datetime',
        'update_time' => 'datetime',
    ];
    
    /**
     * 表单处理
     */
    public static function mForm($template = 'form', $field = 'id', $where = [], $data = [])
    {
        return parent::mForm($template, $field, $where, $data);
    }
}
```

### 必须遵守的规则

1. **继承基类**：必须继承 `think\admin\Model`
2. **表名定义**：必须定义 `$name` 属性
3. **时间戳**：启用自动时间戳 `$autoWriteTimestamp = true`
4. **类型转换**：定义字段类型转换 `$type`
5. **表单方法**：使用 `mForm` 方法处理表单

***

**注意**：严格按照以上标准开发，确保代码规范统一。

## 3. 前端表格组件规范

### 3.1 layui.table 标准使用方法

新版本推荐使用 layui.table 组件显示表格数据，使用封装的 layTable 插件，可动态填充页面高度，支持搜索表单绑定及混合模式调度。

#### 基本HTML结构

```html
<div class="think-box-shadow">
    <table id="OplogData" data-url="{:sysuri()}" data-target-search="form.form-search"></table>
</div>
```

#### JavaScript配置

```javascript
$(function () {
    // 动态创建 layui.table 表格
    $('#OplogData').layTable({
        even: true, height: 'full',
        sort: {field: 'id', type: 'desc'},
        cols: [[
            {checkbox: true},
            {field: 'id', title: 'ID', width: 80, sort: true, align: 'center'},
            {field: 'username', title: '操作账号', minWidth: 100, sort: true, align: 'center'},
            {field: 'node', title: '操作节点', minWidth: 120},
            {field: 'action', title: '操作行为', minWidth: 120},
            {field: 'content', title: '操作描述', minWidth: 120},
            {field: 'geoip', title: '访问地址', minWidth: 100},
            {field: 'geoisp', title: '网络服务商', minWidth: 100},
            {field: 'create_at', title: '操作时间', minWidth: 170, align: 'center', sort: true},
            {toolbar: '#toolbar', title: '操作面板', align: 'center', fixed: 'right'}
        ]]
    });

    // 监听 layui.table 的 tool 事件
    $('#OplogData').trigger('tool', function (item) {
        if (item.event === 'EventName') {
            // 判断 lay-event 名称处理
        }
    });

    // 监听 layui.table 的 toolbar 事件
    $('#OplogData').trigger('toolbar', function (item) {
        // 对应 layui.table 写法 layui.table.on('toolbar(OplogData)',function(){ })
    });

    // jQuery 事件绑定（单页程序需要先 off 再 on）
    $('body').off('click', 'jQ选择器').on('click', 'jQ选择器', function () {
        // 点击事件，可以用 this 读取 Element 对象属性内容
    });
});
```

#### 工具栏模板

```html
<script type="text/html" id="toolbar">
    <!--{if auth('remove')}-->
    <a data-action='{:url("remove")}' data-value="id#{{d.id}}" data-confirm="确认要删除这条记录吗？" class="layui-btn layui-btn-sm layui-btn-danger">删 除</a>
    <!--{/if}-->
</script>
```

### 3.2 QueryHelper 后端数据处理

后端使用 QueryHelper 实现表格数据自动处理，支持前置和后置操作。

#### 基本用法

```php
// 新版本中 QueryHelper 对象支持 Layui 表格数据加载
$query->layTable(function(QueryHelper $query){
    // 前置操作，处理 HTML 模板
}, function(QueryHelper $query){
    // 后置操作，处理表格数据
});
```

#### 完整示例

```php
public function index()
{
    $this->_query()->layTable(function(QueryHelper $query){
        // 前置操作：设置查询条件
        $query->like('username,node,action');
        $query->dateBetween('create_at');
    }, function(QueryHelper $query){
        // 后置操作：数据格式化
        $query->field('id,username,node,action,content,geoip,geoisp,create_at');
    });
}
```

### 3.3 表格组件开发规范

1. **表格ID命名**：使用驼峰命名法，如 `OplogData`、`UserList`
2. **数据URL配置**：使用 `{:sysuri()}` 获取当前控制器方法URL
3. **搜索表单绑定**：使用 `data-target-search` 属性绑定搜索表单
4. **高度设置**：推荐使用 `height: 'full'` 自适应高度
5. **事件监听**：使用 `trigger` 方法监听表格事件，兼容 layui.table 原生写法

### 3.4 注意事项

* 调用 layTable 方法后，默认使用 HttpResponseException 响应直接输出，后续代码不会执行

* 单页程序中绑定事件需要先 `off` 再 `on`，避免重复绑定

* 更多事件绑定参考 layui.table 官方文档：<https://layui.dev/docs/2.8/table/#table.on>

* QueryHelper 详细用法参考：<https://thinkadmin.top/system/helper-query.html>

## 4. 前端模板继承规范

ThinkAdmin 的前端框架基于 LayUI 构建，页面已加载所有 LayUI 官方组件。后台模板页面分为三种类型：

### 4.1 完整异步页面 (full.html)

**适用场景**：无菜单的页面，如登录页面、带分页的选择器 iframe 页面
**打开方式**：`data-iframe` 方式打开或独立页面
**特点**：包含完整的页面 HTML 结构（头部、内容、脚本部分），有加载顺序要求

#### 基本结构

```html
{extend name="../../admin/view/full"}

{block name='style'}
<style>
    /* 自定义页面样式 */
    .header-body {
        height: 50px;
    }
</style>
{/block}

{block name='content'}
<!-- 页面内容部分 -->
<div class="iframe-pagination">
    <textarea name="content"></textarea>
</div>
{/block}

{block name='script'}
<script>
    // 脚本部分，默认加载了所有插件
    $(function () {
        // layui 表单组件初始化
        layui.form.render();
        // layui 组件动作初始化
        layui.element.render();
        // 异步加载富文本编辑器
        require(['ckeditor'], function () {
            // 初始化富文本编辑器
            window.createEditor('[name=content]', {height: 350});
        });
    });
</script>
{/block}
```

### 4.2 内容异步页面 (main.html)

**适用场景**：有菜单的页面，如数据列表页面、独立表单页面
**打开方式**：`data-open` 方式打开
**特点**：只包含内容部分，支持页面标签名称设置及控制按钮，无加载顺序限制

#### 基本结构

```html
{extend name="../../admin/view/main"}

{block name="button"}
<!-- html 按钮区 -->
<button data-open='{:url("add")}' data-title="添加文章内容" class='layui-btn layui-btn-sm layui-btn-primary'>添加文章</button>
<button data-action='{:url("remove")}' data-rule="id#{key}" class='layui-btn layui-btn-sm layui-btn-primary'>删除文章</button>
{/block}

{block name='content'}
<div class="think-box-shadow table-block">
    <!-- html 内容 -->
</div>
{/block}

{block name='style'}
<!-- 样式区，也可放在 content 中，局部加载限制少 -->
<style>
    table {
        /* 自定义样式 */
    }
</style>
{/block}

{block name='script'}
<!-- 自定义脚本区，也可放在 content 中，局部加载限制少-->
<script>
    // layui 表单组件初始化
    layui.form.render();
    // layui 组件动作初始化
    layui.element.render();
    // 异步加载富文本编辑器
    require(['ckeditor'], function () {
        // 初始化富文本编辑器
        window.createEditor('[name=content]', {height: 350});
    });
</script>
{/block}
```

### 4.3 弹层模板页面

**适用场景**：弹层小页面显示，如少量数据表单页面、少量数据内容页面
**打开方式**：`data-modal` 方式打开的弹框子页面
**特点**：只包含内容，不包含头部和脚本代码

#### 基本结构

```html
<form class="layui-form layui-card" action="{:request()->url()}" data-auto="true" method="post" autocomplete="off">
    <div class="layui-card-body padding-left-40">
        <label class="layui-form-item relative block">
            <span class="color-green font-w7">标签名称</span>
            <span class="color-desc margin-left-5">Mark Name</span>
            <input class="layui-input" required placeholder="请输入标签名称" name="name" value="{$vo.name|default=''}"/>
            <span class="help-block"><b>必填，</b>请填写分类名称（如：系统管理），建议字符不要太长，一般4-6个汉字</span>
        </label>
        <div class="layui-form-item relative block">
            <span class="color-green font-w7">标签描述</span>
            <span class="color-desc margin-left-5">Mark Remark</span>
            <label class="relative block">
                <textarea class="layui-textarea" placeholder="请输入文档描述" name="desc">{$vo.desc|default=''}</textarea>
            </label>
        </div>
    </div>
    <div class="hr-line-dashed"></div>
    <div class="layui-form-item text-center">
        <button class="layui-btn" type="submit">保存数据</button>
        <button class="layui-btn layui-btn-danger" type="button" data-confirm="确定要取消编辑吗？" data-close>取消编辑</button>
    </div>
</form>
```

### 4.4 模板选择规范

1. **完整异步页面 (full.html)**：用于登录页面、独立功能页面
2. **内容异步页面 (main.html)**：用于后台管理的主要功能页面
3. **弹层模板页面**：用于简单的表单编辑、数据查看等弹窗场景

### 4.5 注意事项

* 不建议自行升级 LayUI 版本，可能导致云存储无法上传文件

* 第三方插件基于 requirejs 功能加载，符合 AMD/CMD 标准的插件使用 require 函数引入

* 若主模板不存在，可从 admin 应用视图复制

* 完整异步页面有加载顺序要求，代码需按模板块摆放

* 内容异步页面无加载顺序限制，代码可随意放置

* 参考文档：<https://thinkadmin.top/system/extra-layout.html>

